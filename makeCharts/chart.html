<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link
      rel="preload"
      type="text/javascript"
      href="https://cdn.jsdelivr.net/npm/chart.js@3.5.0/dist/chart.min.js"
      as="script"
    />
  </head>
  <body>
    <canvas width="1200" height="800"></canvas>

    <script
      type="text/javascript"
      src="https://cdn.jsdelivr.net/npm/chart.js@3.5.0/dist/chart.min.js"
    ></script>
    <script type="text/javascript">
      (async () => {
        const data = await fetch("data", {
          mode: "no-cors",
        }).then((r) => r.json());

        data.forEach(
          (
            {
              pcr_positive_7_day_average: pcr,
              antigen_positive_7_day_average: antigen,
            },
            i
          ) => (data[i].totalPositive = pcr + antigen)
        );

        window.data = data;

        const canvas = document.querySelector("canvas");
        const ctx = canvas.getContext("2d");
        window.chart = null;

        window.draw = (field, colorRgb) => {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          if (window.chart) {
            window.chart.destroy();
          }

          window.chart = new Chart(ctx, {
            type: "line",
            data: {
              labels: data.map(({ end }) => end),
              datasets: [
                {
                  label: "",
                  data: data.map((d) => d[field]),
                  backgroundColor: `rgba(${colorRgb},0.2)`,
                  borderColor: `rgb(${colorRgb})`,
                  borderWidth: 3,
                  fill: true,
                  pointRadius: 0,
                },
              ],
            },
            options: {
              animation: false,
              plugins: {
                legend: { display: false },
              },
              responsive: false,
              scales: {
                y: {
                  min: 0,
                },
              },
            },
          });

          return canvas.toDataURL();
        };

        draw("totalPositive", "0,170,0");
        draw("icu", "255, 0,0");
      })();
    </script>
  </body>
</html>
